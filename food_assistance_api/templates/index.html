<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Food Assistance Centers Locator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">


  <script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap" async defer></script>
</head>

<body>
  <h2>Find Food Assistance Centers</h2>

  <div class="flex-container">
    <!-- Inputs -->
    <div class="controls">
      <label>Destination ZIP code:</label>
      <input type="text" id="zip" placeholder="e.g. 20010">

      <label>Search Radius (miles):</label>
      <input type="number" id="radius" value="5">

      <button onclick="search()">Search Nearby Locations</button>
    </div>

    <!-- Map -->
    <div class="map-container">
      <div id="map"></div>
    </div>
  </div>

  <script>
    let map, originCoords, markers = [];

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 38.9072, lng: -77.0369 }, // Default to DC
        zoom: 10,
      });

      // Try getting user's location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            originCoords = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            new google.maps.Marker({
              position: originCoords,
              map: map,
              title: "Your Location",
              icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
            });
            map.setCenter(originCoords);
          },
          () => alert("Geolocation failed.")
        );
      }
    }

    function search() {
      const zip = document.getElementById("zip").value;
      const radius = document.getElementById("radius").value;

      if (!zip || !radius) return alert("Please enter ZIP and radius.");

      // Get coordinates for ZIP
      fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${zip}&key={{ api_key }}`)
        .then(res => res.json())
        .then(data => {
          const destCoords = data.results[0].geometry.location;
          map.setCenter(destCoords);

          // Clear old markers
          markers.forEach(m => m.setMap(null));
          markers = [];

          // Simulate a few food banks nearby (replace with backend API)
          const foodBanks = [
            { name: "Food Bank A", lat: destCoords.lat + 0.01, lng: destCoords.lng + 0.01 },
            { name: "Food Bank B", lat: destCoords.lat - 0.008, lng: destCoords.lng + 0.012 },
          ];

          foodBanks.forEach(site => {
            const marker = new google.maps.Marker({
              position: { lat: site.lat, lng: site.lng },
              map: map,
              title: site.name
            });
            markers.push(marker);

            const info = new google.maps.InfoWindow({
              content: `<strong>${site.name}</strong><br><button onclick="navigateTo(${site.lat}, ${site.lng})">Get Directions</button>`
            });

            marker.addListener("click", () => {
              info.open(map, marker);
            });
          });
        });
    }

    function navigateTo(destLat, destLng) {
      if (!originCoords) {
        alert("User location not available.");
        return;
      }
      const origin = `${originCoords.lat},${originCoords.lng}`;
      const dest = `${destLat},${destLng}`;
      const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&travelmode=driving`;
      window.open(url, "_blank");
    }
  </script>
</body>
</html>
